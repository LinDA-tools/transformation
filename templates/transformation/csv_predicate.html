	{% extends "base.html" %}

{% block css %}
{% endblock %}

{% block content %}

{% include "transformation/snippets/title_snippet.html" with format='CSV' %}

<!-- http://stackoverflow.com/questions/13666852/how-to-debug-a-django-multivaluedictkeyerror-on-formset-post -->
{% for hidden in form.hidden_fields %}
    {{ hidden }}
{% endfor %}

<input type="hidden" name="hidden_rdf_array_field" id ="id_hidden_rdf_array_field" value="{{ rdfArray }}">

<div class="content grid">
	<div class="col-5-10 left-side-box">
		<h3>Specify the RDF Predicate</h3>
		<p>...</p>
	</div>

	<div class="col-5-10 right-side-box">
		



	</div>

</div>

<div class="content scrollit">
	<h3>DATA VIEW</h3>
	File: <b>{{ filename }}</b> (10 rows example)
	<table class="table_view">
		{% for line in csvContent|slice:":1" %}
		<tr>
			{% for field in line %}
				<td>				
					<span>{{ field }}</span>			
				</td>
			{% endfor %}
		</tr>
		{% endfor %}


		{% for line in csvContent|slice:":1" %}
		<tr>
			{% for field in line %}
				<td>				
					<span id="search_text_{{ forloop.counter }}"></i></span><br>
					<input type="text" value="{{ field }}" id="search_textinput_{{ forloop.counter }}" onkeyup="delayedOracleCall(event, {{ forloop.counter }})"><i id="icon_{{ forloop.counter }}" class="fa fa-search" onclick="askOracle(event, {{ forloop.counter }})"></i>
					<br>
					<div id="search_result_{{ forloop.counter }}" class="oracle_results_container">no results
					</div>
		
				</td>
			{% endfor %}
		</tr>
		{% endfor %}

		{% for line in csvContent|slice:"1:11" %}
		<tr>
			{% for field in line %}
				<td>				
					<span>{{ field }}</span>			
				</td>
			{% endfor %}
		</tr>
		{% endfor %}
	
	</table>
</div>

<div class="content" id="rdf_view">
	<h3>RDF VIEW</h3>



</div>

</form>

<script>

var rdf_content = document.getElementById("id_hidden_rdf_array_field");
var rdf_view = document.getElementById("rdf_view");
var csv_content = document.getElementById("id_hidden_csv_content_field");

//supress Enter key for form
function stopRKey(evt) {
  var evt = (evt) ? evt : ((event) ? event : null);
  var node = (evt.target) ? evt.target : ((evt.srcElement) ? evt.srcElement : null);
  if ((evt.keyCode == 13) && (node.type=="text"))  {return false;}
}

document.onkeypress = stopRKey;

var recent_result = null;
var recent_textinput = null;
var recent_text = null;

function askOracle(ev, widget_num){

	recent_result = document.getElementById("search_result_"+widget_num);
	recent_textinput = document.getElementById("search_textinput_"+widget_num);
	recent_text = document.getElementById("search_text_"+widget_num);
	recent_icon = document.getElementById("icon_"+widget_num);

	$.ajax({
		type: 'GET',
		dataType: 'jsonp',
		data: { 'q': recent_textinput.value },
		url: "http://linda.epu.ntua.gr:8000/coreapi/recommend/",
		error: function (jqXHR, textStatus, errorThrown) {
			recent_text.innerHTML="error!";
			console.log(error+"\n"+status+"\n"+xhr.responseText);
			recent_icon.className = "fa fa-exclamation-triangle";
		},
		success: function (data) {
			recent_icon.className = "fa fa-check";
			recent_result.innerHTML = "";
			if(data.length==0){
				recent_text.innerHTML="no results";
				console.log("no results");
				return;
				recent_icon.className = "fa fa-meh-o";
			}			
			recent_text.innerHTML = data[0].ranking;
			recent_text.innerHTML = "please choose from list";
			for(var i = 0; i < data.length; i++){
				recent_result.innerHTML += "<div class =\"oracle_result\" id=\"oracle_result_"+widget_num+"_"+i+"\" onclick=\"displayChosenURI(this, "+widget_num+");\"><span class=\"oracle_label\"><em>"+data[i].label+"</em> ("+data[i].vocabulary+")</span><br><a href=\""+data[i].full_uri+"\" target=\"_blank\" onmouseover=\"Tip('"+data[i].full_uri+"')\" onmouseout=\"UnTip()\">"+data[i].full_uri+"</a></div>";

			}
		},
		beforeSend: function(){
			recent_text.innerHTML="loading...";
			recent_icon.className = "fa fa-refresh fa-spin";
		}

	});
}

//only request ajax if no typing for 1 second

var typingTimer;
var doneTypingInterval = 1000;

function delayedOracleCall(ev, widget_num) {
	clearTimeout(typingTimer);
	typingTimer = setTimeout(function(){askOracle(ev, widget_num);}, doneTypingInterval);
}


function displayChosenURI(w, widget_num) {
	recent_text = document.getElementById("search_text_"+widget_num);
	recent_text.innerHTML = w.childNodes[2].href;
	adapt_RDF_preview();
}

function adapt_RDF_preview() {
	var rdf_array = eval(rdf_content.value)
	//console.log(eval(rdf_content.value));

	var same_subject = true;
	var subject = "";

	//how many columns
	var num_columns = eval(csv_content.value)[0].length;

	for(var i=0; i<rdf_array.length/num_columns; i++) {
		for(var j=0; j<num_columns; j++) {
			var widget_id = "search_text_"+(j+1);
			console.log(widget_id);
			console.log(rdf_array[i*num_columns+j]);
			var widget_content = document.getElementById(widget_id).innerHTML;
			rdf_array[i*num_columns+j][1]=widget_content;
		}
	}
	

	var tbl = rdf_array_to_table(rdf_array);
	//store in form and make available in backend
	rdf_content.value = JSON.stringify(rdf_array);
	//make visible in frontend
	var tbl = rdf_array_to_table(rdf_array);
	console.log(tbl);
	while (rdf_view.firstChild) { //remove all children
    		rdf_view.removeChild(rdf_view.firstChild);
	}
	var myH3 = document.createElement("h3");
	myH3.appendChild(document.createTextNode("RDF VIEW"));
	rdf_view.appendChild(myH3);
	rdf_view.appendChild(tbl);
	//return rdf_array;

}


function rdf_array_to_table(rdf_array) {
	// create elements <table> and a <tbody>
	var tbl     = document.createElement("table");
	var tblBody = document.createElement("tbody");

	// cells creation
	for(var i=0; i<rdf_array.length; i++){
		// table row creation
		var row = document.createElement("tr");

		for(var j=0; j<rdf_array[i].length; j++){
			// create element <td> and text node 
		        //Make text node the contents of <td> element
		        // put <td> at end of the table row
			var cell = document.createElement("td");    
			var cellText = document.createTextNode(rdf_array[i][j]); 

                	cell.appendChild(cellText);
                	row.appendChild(cell);
		}

		//row added to end of table body
		tblBody.appendChild(row);
	}

        // append the <tbody> inside the <table>
        tbl.appendChild(tblBody);
 
        tbl.setAttribute("class", "rdf_table");
	return tbl;
}

window.onload = function(){
	rdf_view.innerHTML = "<h3>RDF VIEW +++</h3>";
	console.log(rdf_content.value);
	rdf_view.appendChild(rdf_array_to_table(eval(rdf_content.value)));
	//adapt_RDF_preview();
}

</script>

{% endblock %}

{% block scripts %}
{% endblock %}
