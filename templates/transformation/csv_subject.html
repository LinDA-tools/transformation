	{% extends "base.html" %}

{% block css %}
{% endblock %}

{% block content %}

{% include "transformation/snippets/title_snippet.html" with format='CSV' %}

<!-- http://stackoverflow.com/questions/13666852/how-to-debug-a-django-multivaluedictkeyerror-on-formset-post -->
{% for hidden in form.hidden_fields %}
    {{ hidden }}
{% endfor %}

<div class="content grid">
	<div class="col-5-10 left-side-box">
		<h3>Specify the RDF Subject</h3>
		<p>In this step, you can specify the RDF subject. It will be constructed from a combination of a base URL and a combination of the content of one or multiple column names (i.e. the first row of your CSV file).</p>
		<p>The base URL may be the one of your organization.</p>
		<p>Note that you can also add characters like e.g. hyphens or underscores to construct your subject URI.</p>
	</div>

	<div class="col-5-10 right-side-box">
		
		<p>
			<input type="checkbox" name="blanknodes_only" id="id_blanknodes_only"> I don't want to provide a subject! Use Blank Nodes only!
		</p>
		<div id="id_uri_container">
			<p>
				Base URL: <input type="text" name="base_url" id="id_base_url" placeholder="e.g. http://example.net/" value="http://example.net">
			</p>
			<p>
				To build you subject URI, drag and drop the column name fields below into the subject URI field.
			</p>
			<p>
			{% for line in csvContent|slice:":1" %}
			{% for colname in line %}
				<span class="uribuilder" draggable="true" ondragstart="drag(event)" id="id_dragme_{{ colname }}" name="dragme_{{ colname }}" onmouseover="Tip('Drag this column name to the URI text field below.')" onmouseout="UnTip()">{{ colname }}</span>
			{% endfor %}
			{% endfor %}
			</p>
			<p>
				Subject URI: <span id="id_base_url_insert">http://example.net/</span><input type="text" class="drop-box" name="subject_uri" id="id_subject_uri" ondrop="drop(event)" ondragover="allowDrop(event)">
				<br>
				<span class="warning-text red" id="base_url_insert_warning" style="visibility:hidden;">Wrong formatting. Build the URI template using terms like '{columnName}' surrounded by single brackets.</span>

			</p>
		</div>


	</div>

</div>

<div class="content scrollit">
	<h3>DATA VIEW</h3>
	File: <b>{{ filename }}</b> (10 rows example)
	<table class="table_view">
		{% for line in csvContent %}
		<tr>
			{% for field in line %}
				<td>
				{% if forloop.parentloop.first %}
					<span>{{ field }}</span> <a href="" onclick="addToUri(event)" onmouseover="Tip('Add to subject URI')" onmouseout="UnTip()">[+]</a>
				{% else %}
					{{ field }}
				{% endif %}
			
				</td>
			{% endfor %}
		</tr>
		{% endfor %}	
	</table>
</div>

<div class="content">
	<h3>RDF VIEW</h3>
</div>

</form>

<script>



function isUrl(s) {
   var regexp = /http:\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/
   return regexp.test(s);
}

function allowDrop(ev) {
	ev.preventDefault();
}

function drag(ev) {
	ev.dataTransfer.setData("text", ev.target.innerHTML);
}

function drop(ev) {
	var curser_pos = ev.target.selectionStart;
	ev.preventDefault();
	var data = ev.dataTransfer.getData("text");
	//ev.target.appendChild(document.getElementById(data));
	ev.target.value = ev.target.value.substr(0, curser_pos) + "{"+data+"}" + ev.target.value.substr(curser_pos, ev.target.value.length);
}

function insert_into_uri(s, widget){
	var curser_pos = widget.selectionStart;
	widget.value = widget.value.substr(0, curser_pos) + "{"+s+"}" + widget.value.substr(curser_pos, widget.value.length);
}

var base_url = document.getElementById("id_base_url");
var base_url_insert = document.getElementById("id_base_url_insert");
var subject_uri = document.getElementById("id_subject_uri");
var base_url_insert_warning = document.getElementById("base_url_insert_warning");
var blanknodes_only = document.getElementById("id_blanknodes_only");
var uri_container = document.getElementById("id_uri_container");

blanknodes_only.addEventListener('change', function(){
	if(blanknodes_only.checked)
		uri_container.style.visibility = "hidden";
	else
		uri_container.style.visibility = "visible";
	
});


base_url.addEventListener('keyup', function(){
	trailing_slash = "";
console.log(base_url.value[base_url.value.length-1]);
	if(base_url.value[base_url.value.length-1] != "/")
		trailing_slash = "/";
	if(isUrl(base_url.value))
		base_url_insert.innerHTML = base_url.value + trailing_slash;
	else base_url_insert.innerHTML = " [ Invalid Base URL ] ";
});

function changeURI(){
	base_url_insert_warning.style.visibility = "hidden";
	var last_bracket = "}";
	var warning = false;
	for(var i=0; i<subject_uri.value.length; i++){

		if(subject_uri.value[i]	== last_bracket ){
			base_url_insert_warning.style.visibility = "visible";
			base_url_insert_warning.innerHTML = "Wrong formatting: Open '{' and closed '}' brackets must come in pairs."		
		}
		if(subject_uri.value[i]	== "}" || subject_uri.value[i]	== "{"){
			last_bracket = subject_uri.value[i];
		}
	}
	if(last_bracket == "{"){
		base_url_insert_warning.style.visibility = "visible";
		base_url_insert_warning.innerHTML = "Wrong formatting: Open '{' bracket not closed."
	}
}


//check if subject uri has a valid formatting / open and closed curly brackets {} pairs
subject_uri.addEventListener('keyup', changeURI);
subject_uri.addEventListener('drop', changeURI);

function addToUri(ev){
	ev.preventDefault();
	var column_name = ev.target.parentNode.childNodes[1].innerHTML;
	insert_into_uri(column_name, subject_uri);
	//subject_uri.value = subject_uri.value.substr(0, curser_pos) + "{"+data+"}" + ev.target.value.substr(curser_pos, ev.target.value.length);
}

</script>

{% endblock %}

{% block scripts %}
{% endblock %}
