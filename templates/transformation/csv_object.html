	{% extends "base.html" %}

{% block css %}
{% endblock %}

{% block content %}

{% include "transformation/snippets/title_snippet.html" with format='CSV' %}

<!-- http://stackoverflow.com/questions/13666852/how-to-debug-a-django-multivaluedictkeyerror-on-formset-post -->
{% for hidden in form.hidden_fields %}
    {{ hidden }}
{% endfor %}

<input type="hidden" name="hidden_rdf_array_field" id ="id_hidden_rdf_array_field" value="{{ rdfArray }}">
<input type="hidden" name="hidden_rdf_prefix_field" id ="id_hidden_rdf_prefix_field" value="{{ rdfPrefix }}">

<div class="content grid">
	<div class="col-5-10 left-side-box">
		<h3>Specify the RDF Object</h3>
		<p>In this step, you can either choose a datatype (such as "Text", "Floating Point Number", "Integer", ...) for a table row or try and let us reconsiliate your data against the DBPedia triple store. That is, we will automatically look up an URI in the DBPedia-Project that might represent the data within each of your table rows.</p>
		<p>As always, the results can be seen in the RDF preview at the page bottom.</p>
	</div>

	<div class="col-5-10 right-side-box">
		



	</div>

</div>

<div class="content scrollit">
	<h3>DATA VIEW</h3>
	File: <b>{{ filename }}</b> (10 rows example)
	<table class="table_view">
	<thead>

		{% for line in csvContent|slice:":1" %}
		<tr>
			{% for field in line %}
				<td id="id_table_settings_{{ forloop.counter }}">
					<select>
						<option>no action</option>
						<option>auto inference</option>
						<option>auto type guessing</option>
					</select>
				</td>
			{% endfor %}
		</tr>
		{% endfor %}

		{% for line in csvContent|slice:":1" %}
		<tr>
			{% for field in line %}
				<td id="id_table_head_{{ forloop.counter }}">
					<span>{{ field }}</span>
				</td>
			{% endfor %}
		</tr>
		{% endfor %}


	</thead>
	<tbody>
		{% for line in csvContent|slice:"1:" %}
		<tr>
			{% for field in line %}
				<td id="id_table_field_{{ forloop.counter }}_{{ forloop.parentloop.counter }}">
					<span>{{ field }}</span>
				</td>
			{% endfor %}
		</tr>
		{% endfor %}	
	</tbody>
	</table>
<div style="clear:both;"></div>
</div>

<div class="content" id="rdf_view">
	<h3>RDF VIEW</h3>

</div>

</form>

<script>

    function addInnerDiv(elem) {

        var kids = elem.children();

        elem.empty();

        var innerDiv = jQuery('<div/>', {
            class: "bb_select_inner"
        }).appendTo(elem);

        var selectionDiv = jQuery('<div/>', {
            class: "bb_select_selection",
            text: "please chose"
        }).appendTo(innerDiv);

	selectionDiv.css("position","relative");

	//font awesome arrow down
        var caretDown = jQuery('<i/>', {
            class: "fa fa-caret-square-o-down fa-2x"
        }).appendTo(selectionDiv);

        caretDown.css("position","absolute");
        caretDown.css("top",".1em");
        caretDown.css("right",".2em");
        caretDown.css("color","#888");

        elem.on("mouseover", function() {
        	$(this).find("i:last-child").css("opacity","1");
		$(this).find("div div").css("z-index", 999999);
        });

        elem.on("mouseout", function() {
        	$(this).find("i:last-child").css("opacity",".3");
		$(this).find("div div").css("z-index", "auto");
        });

        var elementsDiv = jQuery('<div/>', {
            class: "bb_select_elements"
        }).appendTo(innerDiv);
        
        elementsDiv.append(kids);

        kids.each(function (i) {
            $(this).on("click", function () {
                $(this).parent().siblings().first().html($(this).html());
                $(this).addClass("bb_select_clicked");
                $(this).siblings().removeClass("bb_select_clicked");
                caretDown.appendTo(selectionDiv);
                adapt_RDF_preview();
            });
        });

        innerDiv.on("mouseover", function () {
            elementsDiv.css("visibility", "visible");
        });

        innerDiv.on("mouseout", function () {
            elementsDiv.css("visibility", "hidden");
        });

        elementsDiv.trigger("mouseout");
    }


//http://localhost:8000/transformation/lookup/place/Berlin/


// e.g. domain = bird; term = sparrow, tit, ..
function askOracle(widget, domain, term){
	//console.log('http://lookup.dbpedia.org/api/search/KeywordSearch?QueryClass=' + domain + '&QueryString=' + term);
	var request = $.ajax({
		type: 'GET',
		dataType: 'json',
		//url: "http://localhost:8000/transformation/lookup/"+domain+"/"+term+"/",
		url: 'http://lookup.dbpedia.org/api/search/KeywordSearch?QueryClass=' + domain + '&QueryString=' + term,
	});

	request.fail(function (xhr, ajaxOptions, thrownError) {
		widget.html(widget.text()+ " (ERROR<br>"+thrownError+")");

	});

	var new_id = "search_result_"+widget.attr("id");
	request.success(function (data) {

		if(data.results.length===0){
			widget.html(widget.html()+"<br><span class=\"red\" onmouseover=\"Tip('We were unable to find results in DBPedia which match this table cell.')\" onmouseout=\"UnTip()\">No reconciliation results.</span>");
		}else{
			var list = "<div class=\"bb_select\" id=\""+new_id+"\">";
			for(var i=0; i<data.results.length; i++){
				var link = "<a href=\""+data.results[i].uri+"\" target=\"_blank\" onmouseover=\"Tip('Open in external window')\" onmouseout=\"UnTip()\"><i class=\"fa fa-external-link-square additl_vert_pad\"></i></a>"
				list += "<div>"+link+data.results[i].uri+"</div>";

			}
			list += "</div>";
			widget.html(widget.html()+"<br>"+list);
			addInnerDiv($("#"+new_id));
			//auto-select first element after oracle call
			$(widget).find("* .bb_select_elements").children().first().trigger("click");
		}

	});

	return request;
}

function guessType(column=""){

	//http://www.sitepoint.com/jquery-basic-regex-selector-examples/
//baseUris = ['Prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>', 'Prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>', 'Prefix xsd: <http://www.w3.org/2001/XMLSchema#>', 'Prefix fn: <http://aksw.org/sparqlify/>'];


	//select integers only
	var intRegex = /[0-9 -()+]+$/;   
	//match any ip address
	var ipRegex = 'bd{1,3}.d{1,3}.d{1,3}.d{1,3}b';  
	//match number in range 0-255
	var num0to255Regex = '^([01][0-9][0-9]|2[0-4][0-9]|25[0-5])$';
	//match number in range 0-999 
	var num0to999Regex = '^([0-9]|[1-9][0-9]|[1-9][0-9][0-9])$';
	//match ints and floats/decimals
	var floatRegex = '[-+]?([0-9]*.[0-9]+|[0-9]+)'; 
	//Match Any number from 1 to 50 inclusive
	var number1to50Regex = /(^[1-9]{1}$|^[1-4]{1}[0-9]{1}$|^50$)/gm;
	//match email address

	var emailRegex = '^[A-Z0-9._%+-]+@[A-Z0-9.-]+.[A-Z]{2,4}$'; 
	//match credit card numbers
	var creditCardRegex = '^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35d{3})d{11})$'; 
	//match username
	var usernameRegex = '/^[a-z0-9_-]{3,16}$/'; 
	//match password
	var passwordRegex = '/^[a-z0-9_-]{6,18}$/'; 
	//Match 8 to 15 character string with at least one upper case letter, one lower case letter, and one digit (useful for passwords).
	var passwordStrengthRegex = /((?=.*d)(?=.*[a-z])(?=.*[A-Z]).{8,15})/gm; 
	//match elements that could contain a phone number
	var phoneNumber = /[0-9-()+]{3,20}/; 

	//MatchDate (e.g. 21/3/2006)
	//var dateRegex = /(d{1,2}/d{1,2}/d{4})/gm; 
	//match date in format MM/DD/YYYY
	var dateMMDDYYYRegex = '^(0[1-9]|1[012])[- /.](0[1-9]|[12][0-9]|3[01])[- /.](19|20)dd$'; 
	//match date in format DD/MM/YYYY
	var dateDDMMYYYRegex = '^(0[1-9]|[12][0-9]|3[01])[- /.](0[1-9]|1[012])[- /.](19|20)dd$'; 

	//match a url
	var urlRegex = '/^(https?://)?([da-z.-]+).([a-z.]{2,6})([/w .-]*)*/?$/'; 
	//match a url slug (letters/numbers/hypens)
	var urlslugRegex = '/^[a-z0-9-]+$/'; 
	//match a url string (Fixes spaces and querystrings)
	var urlRegex = '/(https?://)?([da-z.-]+).([a-z.]{2,6})([/w.-=?]*)*/?/';

	//match domain name (with HTTP)
	var domainRegex = '/(.*?)[^w{3}.]([a-zA-Z0-9]([a-zA-Z0-9-]{0,65}[a-zA-Z0-9])?.)+[a-zA-Z]{2,6}/igm'; 
	//match domain name (www. only) 
	var domainRegex = '/[^w{3}.]([a-zA-Z0-9]([a-zA-Z0-9-]{0,65}[a-zA-Z0-9])?.)+[a-zA-Z]{2,6}/igm'; 
	//match domain name (alternative)
	var domainRegex = '/(.*?).(com|net|org|info|coop|int|com.au|co.uk|org.uk|ac.uk|)/igm'; 
	//match sub domains: www, dev, int, stage, int.travel, stage.travel
	var subDomainRegex = '/(http://|https://)?(www.|dev.)?(int.|stage.)?(travel.)?(.*)+?/igm';


	//http://www.w3.org/TR/xmlschema11-2/#built-in-primitive-datatypes
	var datatypes = {

	"float": {"url": "http://www.w3.org/2001/XMLSchema#float",
		"regex":  /(\+|-)?([0-9]+(\.[0-9]*)?|\.[0-9]+)([Ee](\+|-)?[0-9]+)?|(\+|-)?INF|NaN}/},
	"double": {"url": "http://www.w3.org/2001/XMLSchema#double",
		"regex":  /(\+|-)?([0-9]+(\.[0-9]*)?|\.[0-9]+)([Ee](\+|-)?[0-9]+)? |(\+|-)?INF|NaN/},
	"decimal": {"url": "http://www.w3.org/2001/XMLSchema#decimal",
		"regex": /(\+|-)?([0-9]+(\.[0-9]*)?|\.[0-9]+)/},
	"string": {"url": "http://www.w3.org/2001/XMLSchema#string",
		"regex": ".*"},
/*
	"boolean": {"url": "http://www.w3.org/2001/XMLSchema#boolean",
		"regex": "true|false|0|1"},
	"duration": {"url": "http://www.w3.org/2001/XMLSchema#duration",
		"regex": floatRegex},
	"dateTime": {"url": "http://www.w3.org/2001/XMLSchema#dateTime",
		"regex": floatRegex},
	"time": {"url": "http://www.w3.org/2001/XMLSchema#time",
		"regex": floatRegex},
	"date": {"url": "http://www.w3.org/2001/XMLSchema#date",
		"regex": floatRegex},
	"gYearMonth": {"url": "http://www.w3.org/2001/XMLSchema#gYearMonth",
		"regex": floatRegex},
	"gYear": {"url": "http://www.w3.org/2001/XMLSchema#gYear",
		"regex": floatRegex},
	"gMonthDay": {"url": "http://www.w3.org/2001/XMLSchema#gMonthDay",
		"regex": floatRegex},
	"gDay": {"url": "http://www.w3.org/2001/XMLSchema#gDay",
		"regex": floatRegex},
	"gMonth": {"url": "http://www.w3.org/2001/XMLSchema#gMonth",
		"regex": floatRegex},
	"hexBinary": {"url": "http://www.w3.org/2001/XMLSchema#hexBinary",
		"regex": floatRegex},
	"base64Binary": {"url": "http://www.w3.org/2001/XMLSchema#base64Binary",
		"regex": floatRegex},
	"anyURI": {"url": "http://www.w3.org/2001/XMLSchema#anyURI",
		"regex": floatRegex},
	"QName": {"url": "http://www.w3.org/2001/XMLSchema#QName",
		"regex": floatRegex},
	"NOTATION": {"url": "http://www.w3.org/2001/XMLSchema#NOTATION",
		"regex": floatRegex},
*/
	
	};

	var csv_content = eval($("#id_hidden_csv_content_field").val());
	$("td[id^='id_table_field_"+column+"']").each( function(i){
		var recent_field = $(this);
		//console.log(recent_field.text().trim());
		var select_content = "";
		$.each(datatypes, function(key, value){					
			if(recent_field.text().trim().match(value.regex)){
				select_content += "<option>"+prefixise(value.url)+"</option>";
			}
		});
		recent_field.html(recent_field.text() + "<br><select class=\"type_guessing\">" + select_content+"</select>");
		var id = $(this).attr("id");
		//get row and column field as included in table td id field
		id_array = id.split("_");
		var col = id_array[3];
		var row = id_array[4];
		recent_field.find("select.type_guessing").on("change", function() {
			adapt_RDF_preview();
		});
	});

	adapt_RDF_preview();

}

function noAction(column=""){

	var csv_content = eval($("#id_hidden_csv_content_field").val());
	$("td[id^='id_table_field_"+column+"']").each( function(i){
		var id = $(this).attr("id");
		//get row and column field as included in table td id field
		id_array = id.split("_");
		var col = id_array[3];
		var row = id_array[4];
		$(this).text(csv_content[row][col-1]);
	});
	adapt_RDF_preview();
}


function adapt_RDF_preview() {
	var rdf_array = eval($("#id_hidden_rdf_array_field").val());

	if( Object.prototype.toString.call( rdf_array ) !== '[object Array]' ) {
		var tbl = document.createTextNode("No RDF");
	}else{
//TODO this is done each time anything is clicked, bad performance
		$("td[id^='id_table_field']").each(function(i){
			if($(this).find(".bb_select").length>0) { // has reconsiliation result (dropbox)
				rdf_array[i][2] = prefixise($(this).find(".bb_select_selection").text());
			}
			
			if($(this).find("select.type_guessing").length>0) { // has guessed types

				if(rdf_array[i][2].indexOf("^")>-1)
				{
					rdf_array[i][2] = rdf_array[i][2].substring(0, rdf_array[i][2].indexOf("^"));
				}
				rdf_array[i][2] = rdf_array[i][2] +"^"+$(this).find("select.type_guessing option:selected").text();

			}else{ // no action (no inference, no type guessing)
				if(rdf_array[i][2].indexOf("^")>-1)
					{
						rdf_array[i][2] = rdf_array[i][2].substring(0, rdf_array[i][2].indexOf("^"));
					}			
			}


		});
		//store in form and make available in backend
		$("#id_hidden_rdf_array_field").val(JSON.stringify(rdf_array));
		$("#id_hidden_rdf_prefix_field").val(JSON.stringify(used_prefixes));
		//make visible in frontend
		var tbl = rdf_array_to_table(rdf_array, eval($("#id_hidden_rdf_prefix_field").val()));
	}
	while (rdf_view.firstChild) { //remove all children
	    	rdf_view.removeChild(rdf_view.firstChild);
	}
	var myH3 = document.createElement("h3");
	myH3.appendChild(document.createTextNode("RDF VIEW"));
	rdf_view.appendChild(myH3);
	rdf_view.appendChild(tbl);
}

//check whether to to auto type guessing, econciliation or nothing (select dropbox)
//when providing no param, all fields are checked
function calculateCells(column=""){
		$("td[id^='id_table_field_"+column+"']").each( function(i){
		var id = $(this).attr("id");
		//get row and column field as included in table td id field
		id_array = id.split("_");
		var column = id_array[3];
		//var row = id_array[4];

		var opt = $("#id_table_settings_" + column + " select").find("option:selected").text();

		if(opt == "auto inference") {
			noAction(column); //clear field
			var topic_field = "id_table_head_" + column;
			var topic = $("#"+topic_field).text().trim();
			askOracle($(this), topic, $(this).text().trim());
		}
		else if(opt == "auto type guessing") {
			noAction(column); //clear field
			guessType(column);
		}
		else if(opt == "no action") {
			noAction(column);
		}

	});
}

var rdf_content = $("#id_hidden_rdf_array_field");


$( document ).ready(function() {

	used_prefixes = eval($("#id_hidden_rdf_prefix_field").val());
	if( Object.prototype.toString.call( used_prefixes ) !== '[object Array]' )
		used_prefixes = [];
	console.log(used_prefixes);


	//rdf_view.innerHTML = "<h3>RDF VIEW +++</h3>";
	//rdf_view.appendChild(rdf_array_to_table(eval(rdf_content.val())));
	adapt_RDF_preview();
	// do an oracle lookup on page load

	$("td[id^='id_table_settings_'] select").each(function(){
		$(this).on("change", function(){
			calculateCells(column=$(this).parent().attr("id").slice(-1));
		});
	});

	calculateCells();



});

</script>

{% endblock %}

{% block scripts %}
{% endblock %}
